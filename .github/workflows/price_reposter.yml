name: Telegram Price Reposter

on:
  schedule:
    - cron: "0 3 * * *"
    - cron: "0 9 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repo with write permissions
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true  # ⬅️ ВАЖНО!

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          mkdir -p app

      - name: Create Telegram session file
        run: |
          echo "${{ secrets.USER_SESSION_BASE64 }}" | base64 -d > app/price_reposter_user.session

      - name: Run bot
        env:
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          SOURCE_CHANNELS: ${{ secrets.SOURCE_CHANNELS }}
          TARGET_CHANNEL: ${{ secrets.TARGET_CHANNEL }}
        run: |
          python -m app.main
      
      - name: Commit and push database
        if: always()
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          
          if [ -f "reposter.db" ]; then
            echo "Database file exists, checking for changes..."
            
            # Сначала проверяем статус
            git status
            
            # Используем -f для добавления
            git add -f reposter.db
            
            # Проверяем есть ли изменения
            if ! git diff --cached --quiet; then
              echo "Database changed, committing..."
              git commit -m "Update reposter.db [$(date +'%Y-%m-%d %H:%M:%S UTC')]"
              
              # Пробуем запушить
              if git push; then
                echo "✅ Database pushed successfully!"
              else
                echo "⚠️ Push failed, trying with origin main..."
                git push origin HEAD:main
              fi
            else
              echo "✅ No changes in database"
            fi
          else
            echo "⚠️ Database file not found!"
            ls -la
          fi
      
      # Все равно загружаем как артефакт для надежности
      - name: Upload database artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telegram-bot-files
          path: |
            reposter.db
          retention-days: 7
