name: Telegram Price Reposter

on:
  schedule:
    - cron: "0 3 * * *"
    - cron: "0 9 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # üîë –î–û–ë–ê–í–¨ –≠–¢–û–¢ –ë–õ–û–ö –° –ü–†–ê–í–ê–ú–ò:
    permissions:
      contents: write  # –≠—Ç–æ –≥–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–æ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      actions: read    # –î–∞–µ–º –ø—Ä–∞–≤–æ —á–∏—Ç–∞—Ç—å Actions
    
    steps:
      - name: Checkout repo with write permissions
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true  # ‚¨ÖÔ∏è –í–ê–ñ–ù–û!

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          mkdir -p app

      - name: Create Telegram session file
        run: |
          echo "${{ secrets.USER_SESSION_BASE64 }}" | base64 -d > app/price_reposter_user.session

      - name: Run bot
        env:
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          SOURCE_CHANNELS: ${{ secrets.SOURCE_CHANNELS }}
          TARGET_CHANNEL: ${{ secrets.TARGET_CHANNEL }}
        run: |
          python -m app.main
      
      - name: Commit and push database
        if: always()
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          
          if [ -f "reposter.db" ]; then
            echo "Database file exists, checking for changes..."
            
            # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            git status
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º -f –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            git add -f reposter.db
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            if ! git diff --cached --quiet; then
              echo "Database changed, committing..."
              git commit -m "Update reposter.db [$(date +'%Y-%m-%d %H:%M:%S UTC')]"
              
              # –ü—Ä–æ–±—É–µ–º –∑–∞–ø—É—à–∏—Ç—å
              if git push; then
                echo "‚úÖ Database pushed successfully!"
              else
                echo "‚ö†Ô∏è Push failed, trying with origin main..."
                git push origin HEAD:main
              fi
            else
              echo "‚úÖ No changes in database"
            fi
          else
            echo "‚ö†Ô∏è Database file not found!"
            ls -la
          fi
      
      # –í—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
      - name: Upload database artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telegram-bot-files
          path: |
            reposter.db
          retention-days: 7
