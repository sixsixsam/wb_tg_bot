name: Telegram Price Reposter

on:
  schedule:
    - cron: "0 3 * * *"
    - cron: "0 9 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          mkdir -p app

      - name: Create Telegram session file
        run: |
          echo "${{ secrets.USER_SESSION_BASE64 }}" | base64 -d > app/price_reposter_user.session

      - name: Run bot
        env:
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          SOURCE_CHANNELS: ${{ secrets.SOURCE_CHANNELS }}
          TARGET_CHANNEL: ${{ secrets.TARGET_CHANNEL }}
        run: |
          python -m app.main
      
      # ⬇⬇⬇ КОММИТ БД В РЕПОЗИТОРИЙ ⬇⬇⬇
      - name: Commit and push database
        if: always()
        run: |
          # Настраиваем git
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          
          # Проверяем, существует ли БД
          if [ -f "reposter.db" ]; then
            echo "Database file exists, checking for changes..."
            
            # Добавляем БД в git
            git add reposter.db
            
            # Проверяем есть ли изменения
            if ! git diff --cached --quiet; then
              echo "Database changed, committing..."
              git commit -m "Update reposter.db [$(date +'%Y-%m-%d %H:%M:%S UTC')]"
              
              # Пробуем запушить несколько раз (на случай конфликтов)
              for i in 1 2 3; do
                echo "Push attempt $i/3..."
                if git push origin main; then
                  echo "✅ Database pushed successfully!"
                  break
                else
                  echo "⚠️ Push failed, pulling latest changes..."
                  git pull origin main --rebase
                  sleep 2
                fi
              done
            else
              echo "✅ No changes in database"
            fi
          else
            echo "⚠️ Database file not found!"
            ls -la
          fi
